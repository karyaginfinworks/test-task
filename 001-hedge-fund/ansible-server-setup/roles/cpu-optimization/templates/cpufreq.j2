#!/bin/bash
# CPU Frequency scaling configuration for Intel processors
# Generated by Ansible
# Note: This script is primarily for manual execution
# Ansible tasks handle most optimizations natively

# Set CPU governor for all cores
for cpu in /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor; do
    [ -f "$cpu" ] && echo "{{ cpu_governor }}" > "$cpu"
done

{% if cpu_min_freq != "auto" %}
# Set minimum frequency for all cores
for cpu in /sys/devices/system/cpu/cpu*/cpufreq/scaling_min_freq; do
    [ -f "$cpu" ] && echo "{{ cpu_min_freq }}" > "$cpu"
done
{% endif %}

{% if cpu_max_freq != "auto" %}
# Set maximum frequency for all cores
for cpu in /sys/devices/system/cpu/cpu*/cpufreq/scaling_max_freq; do
    [ -f "$cpu" ] && echo "{{ cpu_max_freq }}" > "$cpu"
done
{% endif %}

# Intel P-State specific settings
if [ -d "/sys/devices/system/cpu/intel_pstate" ]; then
    {% if not enable_turbo_boost %}
    # Disable Intel Turbo Boost
    echo 1 > /sys/devices/system/cpu/intel_pstate/no_turbo
    {% else %}
    # Enable Intel Turbo Boost
    echo 0 > /sys/devices/system/cpu/intel_pstate/no_turbo
    {% endif %}
    
    # Set Intel P-State performance percentages
    echo 100 > /sys/devices/system/cpu/intel_pstate/max_perf_pct
    echo 0 > /sys/devices/system/cpu/intel_pstate/min_perf_pct
fi

echo "Intel CPU optimization completed"
